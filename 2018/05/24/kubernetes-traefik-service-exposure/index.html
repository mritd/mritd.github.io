<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="介绍一种 Traefik 另类的服务暴露方式">
    <meta name="keywords"  content="kubernetes,traefik">
    <meta name="theme-color" content="#000000">
    
    <title>Traefik 另类的服务暴露方式 - 漠然的博客 | mritd Blog</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://mritd.me/2018/05/24/kubernetes-traefik-service-exposure/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Rouge CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/mritd-blog.min.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">漠然</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                    <li>
                        <a href="/about/">About</a>
                    </li>
                    
                    <li>
                        <a href="/tags/">Tags</a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    var __HuxNav__ = {
        close: function(){
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        },
        open: function(){
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }

    // Bind Event
    $toggle.addEventListener('click', function(e){
        if ($navbar.className.indexOf('in') > 0) {
            __HuxNav__.close()
        }else{
            __HuxNav__.open()
        }
    })

    /**
     * Since Fastclick is used to delegate 'touchstart' globally
     * to hack 300ms delay in iOS by performing a fake 'click',
     * Using 'e.stopPropagation' to stop 'touchstart' event from 
     * $toggle/$collapse will break global delegation.
     * 
     * Instead, we use a 'e.target' filter to prevent handler
     * added to document close HuxNav.  
     *
     * Also, we use 'click' instead of 'touchstart' as compromise
     */
    document.addEventListener('click', function(e){
        if(e.target == $toggle) return;
        if(e.target.className == 'icon-bar') return;
        __HuxNav__.close();
    })
</script>


    <!-- Post Header -->
<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/home-bg.jpg')
    }

    
</style>
<header class="intro-header" >
    <div class="header-mask"></div>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/#Kubernetes" title="Kubernetes">Kubernetes</a>
                        
                    </div>
                    <h1>Traefik 另类的服务暴露方式</h1>
                    
                    
                    <h2 class="subheading"></h2>
                    
                    <span class="meta">Posted by 漠然 on May 24, 2018</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <!-- Multi-Lingual -->
                

                <blockquote>
  <p>最近准备重新折腾一下 Kubernetes 的服务暴露方式，以前的方式是彻底剥离 Kubenretes 本身的服务发现，然后改动应用实现 应用+Consul+Fabio 的服务暴露方式；总感觉这种方式不算优雅，所以折腾了一下 Traefik，试了下效果还不错，以下记录了使用 Traefik 的新的服务暴露方式(本文仅针对 HTTP 协议)；</p>
</blockquote>

<h2 id="一traefik-服务暴露方案">一、Traefik 服务暴露方案</h2>

<h3 id="11以前的-consulfabio-方案">1.1、以前的 Consul+Fabio 方案</h3>

<p>以前的服务暴露方案是修改应用代码，使其能对接 Consul，然后 Consul 负责健康监测，检测通过后 Fabio 负责读取，最终上层 Nginx 将流量打到 Fabio 上，Fabio 再将流量路由到健康的 Pod 上；总体架构如下</p>

<p><img src="https://cdn.oss.link/markdown/hkwp3.png" alt="consul+fabio" /></p>

<p>这种架构目前有几点不太好的地方，首先是必须应用能成功集成 Consul，需要动应用代码不通用；其次组件过多增加维护成本，尤其是调用链日志不好追踪；这里面需要吐槽下 Consul 和 Fabio，Consul 的集群设计模式要想做到完全的 HA 那么需要在每个 pod 中启动一个 agent，因为只要这个 agent 挂了那么集群认为其上所有注册服务都挂了，这点很恶心人；而 Fabio 的日志目前好像还是不支持合理的输出，好像只能 stdout；目前来看不论是组件复杂度还是维护成本都不怎么友好</p>

<h3 id="12新的-traefik-方案">1.2、新的 Traefik 方案</h3>

<p>使用 Traefik 首先想到就是直接怼 Ingress，这个确实方便也简单；但是在集群 kube-proxy 不走 ipvs 的情况下 iptables 性能确实堪忧；虽说 Traefik 会直连 Pod，但是你 Ingress 暴露 80、443 端口在本机没有对应 Ingress Controller 的情况下还是会走一下 iptables；<strong>不论是换 kube-router、kube-proxy 走 ipvs 都不是我想要的，我们需要一种完全远离 Kubernetes Service 的新路子</strong>；在看 Traefik 文档的时候，其中说明了 Traefik 只利用 Kubernetes 的 API 来读取相关后端数据，那么我们就可以以此来使用如下的套路</p>

<p><img src="https://cdn.oss.link/markdown/tfo2f.png" alt="traefik" /></p>

<p>这个套路的方案很简单，<strong>将 Traefik 部署在物理机上，让其直连 Kubernets api 以读取 Ingress 配置和 Pod IP 等信息，然后在这几台物理机上部署好 Kubernetes 的网络组件使其能直连 Pod IP</strong>；这种方案能够让流量经过 Traefik 直接路由到后端 Pod，健康检测还是由集群来做；<strong>由于 Traefik 连接 Kubernetes api 需要获取一些数据；所以在集群内还是像往常一样创建 Ingress，只不过此时我们并没有 Ingress Controller；这样避免了经过 iptables 转发，不占用全部集群机器的 80、443 端口，同时还能做到高可控</strong></p>

<h2 id="二traefik-部署">二、Traefik 部署</h2>

<p>部署之前首先需要有一个正常访问的集群，然后在另外几台机器上部署 Kubernetes 的网络组件；最终要保证另外几台机器能够直接连通 Pod 的 IP，我这里偷懒直接在 Kubernetes 的其中几个 Node 上部署 Traefik</p>

<h3 id="21docker-compose">2.1、Docker Compose</h3>

<p>Traefik 的 Docker Compose 如下</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.5'</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">traefik</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">traefik:v1.6.1-alpine</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">traefik</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">--configFile=/etc/traefik.toml</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">2080:2080"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">2180:2180"</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./traefik.toml:/etc/traefik.toml</span>
      <span class="pi">-</span> <span class="s">./k8s-root-ca.pem:/etc/kubernetes/ssl/k8s-root-ca.pem</span>
      <span class="pi">-</span> <span class="s">./log:/var/log/traefik</span>
</code></pre></div></div>

<p>由于 Kubernetes 集群开启了 RBAC 认证同时采用 TLS 通讯，所以需要挂载 Kubernetes CA 证书，还需要为 Traefik 创建对应的 RBAC 账户以使其能够访问 Kubernetes API</p>

<h3 id="22创建-rbac-账户">2.2、创建 RBAC 账户</h3>

<p>Traefik 连接 Kubernetes API 时需要使用 Service Account 的 Token，Service Account 以及 ClusterRole 等配置具体见 <a href="https://docs.traefik.io/user-guide/kubernetes/">官方文档</a>，下面是我从当前版本的文档中 Copy 出来的</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">traefik-ingress-controller</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
<span class="nn">---</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1beta1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">traefik-ingress-controller</span>
<span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">services</span>
      <span class="pi">-</span> <span class="s">endpoints</span>
      <span class="pi">-</span> <span class="s">secrets</span>
    <span class="na">verbs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">get</span>
      <span class="pi">-</span> <span class="s">list</span>
      <span class="pi">-</span> <span class="s">watch</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">extensions</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">ingresses</span>
    <span class="na">verbs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">get</span>
      <span class="pi">-</span> <span class="s">list</span>
      <span class="pi">-</span> <span class="s">watch</span>
<span class="nn">---</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1beta1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">traefik-ingress-controller</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">traefik-ingress-controller</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">traefik-ingress-controller</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
</code></pre></div></div>

<p>创建好以后需要提取 Service Account 的 Token 方便下面使用，提取命令如下</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl describe secret <span class="nt">-n</span> kube-system <span class="si">$(</span>kubectl get secrets <span class="nt">-n</span> kube-system | <span class="nb">grep </span>traefik-ingress-controller | <span class="nb">cut</span> <span class="nt">-f1</span> <span class="nt">-d</span> <span class="s1">' '</span><span class="si">)</span> | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'^token'</span>
</code></pre></div></div>

<h3 id="23创建-traefik-配置">2.3、创建 Traefik 配置</h3>

<p>Traefik 的具体配置细节请参考 <a href="https://docs.traefik.io/configuration/commons/">官方文档</a>，以下仅给出一个样例配置</p>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># DEPRECATED - for general usage instruction see [lifeCycle.graceTimeOut].</span>
<span class="c">#</span>
<span class="c"># If both the deprecated option and the new one are given, the deprecated one</span>
<span class="c"># takes precedence.</span>
<span class="c"># A value of zero is equivalent to omitting the parameter, causing</span>
<span class="c"># [lifeCycle.graceTimeOut] to be effective. Pass zero to the new option in</span>
<span class="c"># order to disable the grace period.</span>
<span class="c">#</span>
<span class="c"># Optional</span>
<span class="c"># Default: "0s"</span>
<span class="c">#</span>
<span class="c"># graceTimeOut = "10s"</span>

<span class="c"># Enable debug mode.</span>
<span class="c"># This will install HTTP handlers to expose Go expvars under /debug/vars and</span>
<span class="c"># pprof profiling data under /debug/pprof.</span>
<span class="c"># The log level will be set to DEBUG unless `logLevel` is specified.</span>
<span class="c">#</span>
<span class="c"># Optional</span>
<span class="c"># Default: false</span>
<span class="c">#</span>
<span class="c"># debug = true</span>

<span class="c"># Periodically check if a new version has been released.</span>
<span class="c">#</span>
<span class="c"># Optional</span>
<span class="c"># Default: true</span>
<span class="c">#</span>
<span class="py">checkNewVersion</span> <span class="p">=</span> <span class="kc">false</span>

<span class="c"># Backends throttle duration.</span>
<span class="c">#</span>
<span class="c"># Optional</span>
<span class="c"># Default: "2s"</span>
<span class="c">#</span>
<span class="c"># providersThrottleDuration = "2s"</span>

<span class="c"># Controls the maximum idle (keep-alive) connections to keep per-host.</span>
<span class="c">#</span>
<span class="c"># Optional</span>
<span class="c"># Default: 200</span>
<span class="c">#</span>
<span class="c"># maxIdleConnsPerHost = 200</span>

<span class="c"># If set to true invalid SSL certificates are accepted for backends.</span>
<span class="c"># This disables detection of man-in-the-middle attacks so should only be used on secure backend networks.</span>
<span class="c">#</span>
<span class="c"># Optional</span>
<span class="c"># Default: false</span>
<span class="c">#</span>
<span class="c"># insecureSkipVerify = true</span>

<span class="c"># Register Certificates in the rootCA.</span>
<span class="c">#</span>
<span class="c"># Optional</span>
<span class="c"># Default: []</span>
<span class="c">#</span>
<span class="c"># rootCAs = [ "/mycert.cert" ]</span>

<span class="c"># Entrypoints to be used by frontends that do not specify any entrypoint.</span>
<span class="c"># Each frontend can specify its own entrypoints.</span>
<span class="c">#</span>
<span class="c"># Optional</span>
<span class="c"># Default: ["http"]</span>
<span class="c">#</span>
<span class="c"># defaultEntryPoints = ["http", "https"]</span>

<span class="c"># Allow the use of 0 as server weight.</span>
<span class="c"># - false: a weight 0 means internally a weight of 1.</span>
<span class="c"># - true: a weight 0 means internally a weight of 0 (a server with a weight of 0 is removed from the available servers).</span>
<span class="c">#</span>
<span class="c"># Optional</span>
<span class="c"># Default: false</span>
<span class="c">#</span>
<span class="c"># AllowMinWeightZero = true</span>

<span class="py">logLevel</span> <span class="p">=</span> <span class="s">"INFO"</span>

<span class="nn">[traefikLog]</span>
  <span class="py">filePath</span> <span class="p">=</span> <span class="s">"/var/log/traefik/traefik.log"</span>
  <span class="py">format</span>   <span class="p">=</span> <span class="s">"json"</span>

<span class="nn">[accessLog]</span>
  <span class="py">filePath</span> <span class="p">=</span> <span class="s">"/var/log/traefik/access.log"</span>
  <span class="py">format</span> <span class="p">=</span> <span class="s">"json"</span>

  <span class="nn">[accessLog.filters]</span>
    <span class="py">statusCodes</span> <span class="p">=</span> <span class="nn">["200-511"]</span>
    <span class="py">retryAttempts</span> <span class="p">=</span> <span class="kc">true</span>

<span class="c">#  [accessLog.fields]</span>
<span class="c">#    defaultMode = "keep"</span>
<span class="c">#    [accessLog.fields.names]</span>
<span class="c">#      "ClientUsername" = "drop"</span>
<span class="c">#      # ...</span>
<span class="c">#</span>
<span class="c">#    [accessLog.fields.headers]</span>
<span class="c">#      defaultMode = "keep"</span>
<span class="c">#      [accessLog.fields.headers.names]</span>
<span class="c">#        "User-Agent" = "redact"</span>
<span class="c">#        "Authorization" = "drop"</span>
<span class="c">#        "Content-Type" = "keep"</span>
<span class="c">#        # ...</span>


<span class="nn">[entryPoints]</span>
  <span class="nn">[entryPoints.http]</span>
    <span class="py">address</span> <span class="p">=</span> <span class="s">":2080"</span>
    <span class="py">compress</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="nn">[entryPoints.traefik]</span>
    <span class="py">address</span> <span class="p">=</span> <span class="s">":2180"</span>
    <span class="py">compress</span> <span class="p">=</span> <span class="kc">true</span>

<span class="c">#    [entryPoints.http.whitelist]</span>
<span class="c">#      sourceRange = ["192.168.1.0/24"]</span>
<span class="c">#      useXForwardedFor = true</span>

<span class="c">#    [entryPoints.http.tls]</span>
<span class="c">#      minVersion = "VersionTLS12"</span>
<span class="c">#      cipherSuites = [</span>
<span class="c">#        "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256",</span>
<span class="c">#        "TLS_RSA_WITH_AES_256_GCM_SHA384"</span>
<span class="c">#       ]</span>
<span class="c">#      [[entryPoints.http.tls.certificates]]</span>
<span class="c">#        certFile = "path/to/my.cert"</span>
<span class="c">#        keyFile = "path/to/my.key"</span>
<span class="c">#      [[entryPoints.http.tls.certificates]]</span>
<span class="c">#        certFile = "path/to/other.cert"</span>
<span class="c">#        keyFile = "path/to/other.key"</span>
<span class="c">#      # ...</span>
<span class="c">#      [entryPoints.http.tls.clientCA]</span>
<span class="c">#        files = ["path/to/ca1.crt", "path/to/ca2.crt"]</span>
<span class="c">#        optional = false</span>
<span class="c">#</span>
<span class="c">#    [entryPoints.http.redirect]</span>
<span class="c">#      entryPoint = "https"</span>
<span class="c">#      regex = "^http://localhost/(.*)"</span>
<span class="c">#      replacement = "http://mydomain/$1"</span>
<span class="c">#      permanent = true</span>
<span class="c">#</span>
<span class="c">#    [entryPoints.http.auth]</span>
<span class="c">#      headerField = "X-WebAuth-User"</span>
<span class="c">#      [entryPoints.http.auth.basic]</span>
<span class="c">#        users = [</span>
<span class="c">#          "test:$apr1$H6uskkkW$IgXLP6ewTrSuBkTrqE8wj/",</span>
<span class="c">#          "test2:$apr1$d9hr9HBB$4HxwgUir3HP4EsggP/QNo0",</span>
<span class="c">#        ]</span>
<span class="c">#        usersFile = "/path/to/.htpasswd"</span>
<span class="c">#      [entryPoints.http.auth.digest]</span>
<span class="c">#        users = [</span>
<span class="c">#          "test:traefik:a2688e031edb4be6a3797f3882655c05",</span>
<span class="c">#          "test2:traefik:518845800f9e2bfb1f1f740ec24f074e",</span>
<span class="c">#        ]</span>
<span class="c">#        usersFile = "/path/to/.htdigest"</span>
<span class="c">#      [entryPoints.http.auth.forward]</span>
<span class="c">#        address = "https://authserver.com/auth"</span>
<span class="c">#        trustForwardHeader = true</span>
<span class="c">#        [entryPoints.http.auth.forward.tls]</span>
<span class="c">#          ca =  [ "path/to/local.crt"]</span>
<span class="c">#          caOptional = true</span>
<span class="c">#          cert = "path/to/foo.cert"</span>
<span class="c">#          key = "path/to/foo.key"</span>
<span class="c">#          insecureSkipVerify = true</span>
<span class="c">#</span>
<span class="c">#    [entryPoints.http.proxyProtocol]</span>
<span class="c">#      insecure = true</span>
<span class="c">#      trustedIPs = ["10.10.10.1", "10.10.10.2"]</span>
<span class="c">#</span>
<span class="c">#    [entryPoints.http.forwardedHeaders]</span>
<span class="c">#      trustedIPs = ["10.10.10.1", "10.10.10.2"]</span>
<span class="c">#</span>
<span class="c">#  [entryPoints.https]</span>
<span class="c">#    # ...</span>

<span class="c">################################################################</span>
<span class="c"># Kubernetes Ingress configuration backend</span>
<span class="c">################################################################</span>

<span class="c"># Enable Kubernetes Ingress configuration backend.</span>
<span class="nn">[kubernetes]</span>

<span class="c"># Kubernetes server endpoint.</span>
<span class="c">#</span>
<span class="c"># Optional for in-cluster configuration, required otherwise.</span>
<span class="c"># Default: empty</span>
<span class="c">#</span>
<span class="py">endpoint</span> <span class="p">=</span> <span class="s">"https://172.16.0.36:6443"</span>

<span class="c"># Bearer token used for the Kubernetes client configuration.</span>
<span class="c">#</span>
<span class="c"># Optional</span>
<span class="c"># Default: empty</span>
<span class="c">#</span>
<span class="py">token</span> <span class="p">=</span> <span class="s">"eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJ0cmFlZmlrLWluZ3Jlc3MtY29udHJvbGxlci10b2tlbi1zbm5iNSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJ0cmFlZmlrLWlyZ3Jlc3MtY29udHJvbGxlciIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImE4NmI3YWEzLTVmNjQtMTFlOC1hZjYxLWM4MWY2NmUwMzRhNyIsInN1YiI6InN5c3RlbTpxZXJ2aWNlYWNjb3VudDPrdWJlLXN5c3RlbTp0cmFlZmlrLWluZ3Jlc3MtY29udHJvbGxlciJ9.vOFEITuANWGnkER8gukWkTs54BmHXqNpzM55bOb5qXPmI3pZsbei3gtE6tZoqME9P5Lb85cav-8mGZJcoQqqxNBkZJ1YRqy_1O9Apkxa4jA68ipe_NB3L5-exH5cEIrU8iql_r7ycDaKwzsMnAWGPolp1dRkF31u5u8g68oLwF3GR8Z5g4_tLJlTvA53doX7k6Wd6vUygTS3EaQ_qvfXwbcIeaSdWWo2Mym6O0CvIap4jH2w21MbredGURqkRlXEPezKAgRVkr75CdvuvwORnT8YxFLVwuAJs70V-13Ib9v6HAK64GmzcqkAuJtZT8NZKl8Y4TfRGl2_RMq2tk86gD4ShDMedcrto44ZUYHQccsSlpaW5PsN2KBBNPN0-6ca3jIpOmnJojAFUYGM42Wymnx9_4XwHUeeA18-RrercmOaRMdlNq8BzBomAxQB99TqUzRIqpe6m5OotXvouCUnE7qjMwRWmQ5LHjqUGEw_A1pHcalFXQZK0sOCaJOJZIJbc_8rVX-4uxkCBxoIXmzjq8x5a_xPsN4L0aWifkP6co--agw3kOT0O6my8T_CbcZGO9e3OqYPdT4FSl92XlXW8EXHdDpCUJ10aoqJGG2vZSud7IoDxkcScpkj3n6TvyvSRVtk3CtYiIYBpgi7-X2JKkun1a7yFpLogyazz9VlUE4"</span>

<span class="c"># Path to the certificate authority file.</span>
<span class="c"># Used for the Kubernetes client configuration.</span>
<span class="c">#</span>
<span class="c"># Optional</span>
<span class="c"># Default: empty</span>
<span class="c">#</span>
<span class="py">certAuthFilePath</span> <span class="p">=</span> <span class="s">"/etc/kubernetes/ssl/k8s-root-ca.pem"</span>

<span class="c"># Array of namespaces to watch.</span>
<span class="c">#</span>
<span class="c"># Optional</span>
<span class="c"># Default: all namespaces (empty array).</span>
<span class="c">#</span>
<span class="py">namespaces</span> <span class="p">=</span> <span class="nn">["default"]</span>

<span class="c"># Ingress label selector to filter Ingress objects that should be processed.</span>
<span class="c">#</span>
<span class="c"># Optional</span>
<span class="c"># Default: empty (process all Ingresses)</span>
<span class="c">#</span>
<span class="c"># labelselector = "A and not B"</span>

<span class="c"># Value of `kubernetes.io/ingress.class` annotation that identifies Ingress objects to be processed.</span>
<span class="c"># If the parameter is non-empty, only Ingresses containing an annotation with the same value are processed.</span>
<span class="c"># Otherwise, Ingresses missing the annotation, having an empty value, or the value `traefik` are processed.</span>
<span class="c">#</span>
<span class="c"># Note : `ingressClass` option must begin with the "traefik" prefix.</span>
<span class="c">#</span>
<span class="c"># Optional</span>
<span class="c"># Default: empty</span>
<span class="c">#</span>
<span class="c"># ingressClass = "traefik-internal"</span>

<span class="c"># Disable PassHost Headers.</span>
<span class="c">#</span>
<span class="c"># Optional</span>
<span class="c"># Default: false</span>
<span class="c">#</span>
<span class="c"># disablePassHostHeaders = true</span>

<span class="c"># Enable PassTLSCert Headers.</span>
<span class="c">#</span>
<span class="c"># Optional</span>
<span class="c"># Default: false</span>
<span class="c">#</span>
<span class="c"># enablePassTLSCert = true</span>

<span class="c"># Override default configuration template.</span>
<span class="c">#</span>
<span class="c"># Optional</span>
<span class="c"># Default: &lt;built-in template&gt;</span>
<span class="c">#</span>
<span class="c"># filename = "kubernetes.tmpl"</span>


<span class="c"># API definition</span>
<span class="nn">[api]</span>
  <span class="c"># Name of the related entry point</span>
  <span class="c">#</span>
  <span class="c"># Optional</span>
  <span class="c"># Default: "traefik"</span>
  <span class="c">#</span>
  <span class="py">entryPoint</span> <span class="p">=</span> <span class="s">"traefik"</span>

  <span class="c"># Enabled Dashboard</span>
  <span class="c">#</span>
  <span class="c"># Optional</span>
  <span class="c"># Default: true</span>
  <span class="c">#</span>
  <span class="py">dashboard</span> <span class="p">=</span> <span class="kc">true</span>

  <span class="c"># Enable debug mode.</span>
  <span class="c"># This will install HTTP handlers to expose Go expvars under /debug/vars and</span>
  <span class="c"># pprof profiling data under /debug/pprof.</span>
  <span class="c"># Additionally, the log level will be set to DEBUG.</span>
  <span class="c">#</span>
  <span class="c"># Optional</span>
  <span class="c"># Default: false</span>
  <span class="c">#</span>
  <span class="py">debug</span> <span class="p">=</span> <span class="kc">false</span>

<span class="c"># Ping definition</span>
<span class="c">#[ping]</span>
<span class="c">#  # Name of the related entry point</span>
<span class="c">#  #</span>
<span class="c">#  # Optional</span>
<span class="c">#  # Default: "traefik"</span>
<span class="c">#  #</span>
<span class="c">#  entryPoint = "traefik"</span>
</code></pre></div></div>

<h3 id="24启动-traefik">2.4、启动 Traefik</h3>

<p>所有文件准备好以后直接执行 <code class="language-plaintext highlighter-rouge">docker-compose up -d</code> 启动即可，所有文件目录结构如下</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>traefik
├── docker-compose.yaml
├── k8s-root-ca.pem
├── log
│   ├── access.log
│   └── traefik.log
├── rbac.yaml
└── traefik.toml
</code></pre></div></div>

<p>启动成功后可以访问 <code class="language-plaintext highlighter-rouge">http://IP:2180</code> 查看 Traefik 的控制面板</p>

<p><img src="https://cdn.oss.link/markdown/phrps.png" alt="dashboard" /></p>

<h2 id="三增加-ingress-配置并测试">三、增加 Ingress 配置并测试</h2>

<h3 id="31增加-ingress-配置">3.1、增加 Ingress 配置</h3>

<p>虽然这种部署方式脱离了 Kubernetes 的 Service 与 Ingress 负载，但是 Traefik 还是需要通过 Kubernetes 的 Ingress 配置来确定后端负载规则，所以 Ingress 对象我们仍需照常创建；以下为一个 Demo 项目的 deployment、service、ingress 配置示例</p>

<ul>
  <li>demo.deploy.yaml</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">demo</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">5</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">demo</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">demo</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">demo</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">mritd/demo</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">80</span>
</code></pre></div></div>

<ul>
  <li>demo.svc.yaml</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">demo</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">svc</span><span class="pi">:</span> <span class="s">demo</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">http</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="m">80</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">demo</span>
</code></pre></div></div>

<ul>
  <li>demo.ing.yaml</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">extensions/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Ingress</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">demo</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="s">traefik.ingress.kubernetes.io/preserve-host</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">host</span><span class="pi">:</span> <span class="s">demo.mritd.me</span>
    <span class="na">http</span><span class="pi">:</span>
      <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">backend</span><span class="pi">:</span>
          <span class="na">serviceName</span><span class="pi">:</span> <span class="s">demo</span>
          <span class="na">servicePort</span><span class="pi">:</span> <span class="m">8080</span>
</code></pre></div></div>

<h3 id="32测试访问">3.2、测试访问</h3>

<p>部署好后应当能从 Traefik 的 Dashboard 中看到新增的 demo ingress，如下所示</p>

<p><img src="https://cdn.oss.link/markdown/zociy.png" alt="dashboard-demo" /></p>

<p>最后我们使用 curl 测试即可</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 在不使用 Host 头的情况下 Traefik 会返 404(Traefik 根据 Host 路由后端，具体配置参考官方文档)</span>
test36.node ➜  ~ curl http://172.16.0.36:2080
404 page not found

<span class="c"># 指定 Host 头来路由到 demo 的相关 Pod</span>
test36.node ➜  ~ curl <span class="nt">-H</span> <span class="s2">"Host: demo.mritd.me"</span> http://172.16.0.36:2080
&lt;<span class="o">!</span>DOCTYPE html&gt;
&lt;html <span class="nv">lang</span><span class="o">=</span><span class="s2">"zh"</span><span class="o">&gt;</span>
&lt;<span class="nb">head</span><span class="o">&gt;</span>
    &lt;meta http-equiv<span class="o">=</span><span class="s2">"Content-Type"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"text/html; charset=UTF-8"</span><span class="o">&gt;</span>
    &lt;title&gt;Running!&lt;/title&gt;
    &lt;style <span class="nb">type</span><span class="o">=</span><span class="s2">"text/css"</span><span class="o">&gt;</span>
        body <span class="o">{</span>
            width: 100%<span class="p">;</span>
            min-height: 100%<span class="p">;</span>
            background: linear-gradient<span class="o">(</span>to bottom, <span class="c">#fff 0, #b8edff 50%, #83dfff 100%);</span>
            background-attachment: fixed<span class="p">;</span>
        <span class="o">}</span>
    &lt;/style&gt;
&lt;/head&gt;
&lt;body <span class="nv">class</span><span class="o">=</span><span class="s2">" hasGoogleVoiceExt"</span><span class="o">&gt;</span>
&lt;div <span class="nv">align</span><span class="o">=</span><span class="s2">"center"</span><span class="o">&gt;</span>
    &lt;h1&gt;Your container is running!&lt;/h1&gt;
    &lt;img <span class="nv">src</span><span class="o">=</span><span class="s2">"./docker.png"</span> <span class="nv">alt</span><span class="o">=</span><span class="s2">"docker"</span><span class="o">&gt;</span>
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;#
</code></pre></div></div>

<h2 id="四其他说明">四、其他说明</h2>

<p>写这篇文章的目的是给予一种新的服务暴露思路，这篇文章的某些配置并不适合生产使用；<strong>生产环境尽量使用独立的机器部署 Traefik，同时最好宿主机二进制方式部署；应用的 Deployment 也应当加入健康检测以防止错误的流量路由</strong>；至于 Traefik 的具体细节配置，比如访问日志、Entrypoints 配置、如何连接 Kubernets HA api 等不在本文范畴内，请自行查阅文档；</p>

<p>最后说一下，关于 Traefik 的 HA 只需要部署多个实例即可，还有 Traefik 本身不做日志滚动等，需要自行处理一下日志。</p>

<p>转载请注明出处，本文采用 <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">CC4.0</a> 协议授权</p>


                <hr style="visibility: hidden;">

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2018/05/11/add-commit-message-style-check-to-your-gitlab/" data-toggle="tooltip" data-placement="top" title="为你的 GitLab 增加提交信息检测">
                        Previous<br>
                        <span>为你的 GitLab 增加提交信息检测</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2018/08/09/create-a-plugin-for-kubectl/" data-toggle="tooltip" data-placement="top" title="编写 kubectl 插件">
                        Next<br>
                        <span>编写 kubectl 插件</span>
                        </a>
                    </li>
                    
                </ul>


                
                <!-- disqus 评论框 start -->
                <div class="comment">
                    <div id="disqus_thread" class="disqus-thread"></div>
                </div>
                <!-- disqus 评论框 end -->
                

                
            </div>  

    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                        
                            
                                <a href="/tags/#Linux" title="Linux" rel="84">
                                    Linux
                                </a>
                            
                        
                            
                                <a href="/tags/#SQL" title="SQL" rel="4">
                                    SQL
                                </a>
                            
                        
                            
                                <a href="/tags/#Java" title="Java" rel="25">
                                    Java
                                </a>
                            
                        
                            
                                <a href="/tags/#随笔" title="随笔" rel="9">
                                    随笔
                                </a>
                            
                        
                            
                                <a href="/tags/#GitHub" title="GitHub" rel="3">
                                    GitHub
                                </a>
                            
                        
                            
                                <a href="/tags/#Docker" title="Docker" rel="44">
                                    Docker
                                </a>
                            
                        
                            
                                <a href="/tags/#Kubernetes" title="Kubernetes" rel="46">
                                    Kubernetes
                                </a>
                            
                        
                            
                                <a href="/tags/#CI/CD" title="CI/CD" rel="4">
                                    CI/CD
                                </a>
                            
                        
                            
                                <a href="/tags/#Golang" title="Golang" rel="7">
                                    Golang
                                </a>
                            
                        
                            
                                <a href="/tags/#Mac" title="Mac" rel="1">
                                    Mac
                                </a>
                            
                        
                            
                                <a href="/tags/#Podman" title="Podman" rel="1">
                                    Podman
                                </a>
                            
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">
                    
                        <li><a href="http://mdba.cn">DBA的罗浮宫</a></li>
                    
                        <li><a href="http://www.xieyuxuan.cc">谢雨轩</a></li>
                    
                        <li><a href="https://ehlxr.me">Ehlxr's Blog</a></li>
                    
                        <li><a href="http://www.dearzd.com/DBlog">咚门</a></li>
                    
                        <li><a href="http://log.zvz.im">Z</a></li>
                    
                        <li><a href="https://www.4spaces.org">容休博客</a></li>
                    
                        <li><a href="http://www.webank.pw">幽鸿居</a></li>
                    
                        <li><a href="http://ephen.me">Ephen's Blog</a></li>
                    
                        <li><a href="https://www.maoxuner.cn">二次元の技术宅</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>






<!-- disqus 公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "mritd";
    var disqus_identifier = "/2018/05/24/kubernetes-traefik-service-exposure";
    var disqus_url = "https://mritd.me/2018/05/24/kubernetes-traefik-service-exposure/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus 公共JS代码 end -->




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://twitter.com/mritd1234">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    

                    <!-- add Weibo, Zhihu by Hux, add target = "_blank" to <a> by Hux -->
                    
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://t.me/mritd">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-telegram fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/mritd">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; 漠然 2020
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=huxpro&repo=huxpro.github.io&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/mritd-blog.min.js "></script>

<!-- Service Worker -->

<script src="/js/snackbar.js "></script>
<script src="/js/sw-registration.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async('/js/jquery.tagcloud.js',function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->

<script>
    // dynamic User by Hux
    var _gaId = 'UA-82387173-1';
    var _gaDomain = 'mritd.me';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog (selector) {

        // interop with multilangual 
        if (false) {
            _containerSelector = 'div.post-container.active'
        } else {
            _containerSelector = 'div.post-container'
        }

        // init
        var P = $(_containerSelector),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        // clean
        $(selector).html('')

        // appending
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>



<!-- Multi-Lingual -->




<!-- Image to hack wechat -->
<img src="/img/avatar.jpg" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
